AWSTemplateFormatVersion: '2010-09-09'
Description: asterix-nhs-files
Transform:
- AWS::Serverless-2016-10-31
Resources:
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS'''
        AllowHeaders: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
        AllowOrigin: '''*'''
        MaxAge: '''600'''
      Auth:
        DefaultAuthorizer: LambdaAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          LambdaAuthorizer:
            FunctionArn:
              Fn::GetAtt:
              - AuthorizerFunction
              - Arn
            Identity:
              Headers:
              - Authorization
  AuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/authorizer.authorizerHandler
      Runtime: nodejs22.x
      Architectures:
      - x86_64
      MemorySize: 128
      Timeout: 10
      Description: API Gateway Lambda Authorizer
      CodeUri: AuthorizerFunction
    Metadata:
      SamResourceId: AuthorizerFunction
  FilesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-files-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
  uploadFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/upload-file.uploadFileHandler
      Runtime: nodejs22.x
      Architectures:
      - x86_64
      MemorySize: 256
      Timeout: 30
      Description: Upload files directly to the S3 bucket
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: FilesBucket
      - DynamoDBCrudPolicy:
          TableName:
            Ref: NHSLettersTable
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: FilesBucket
          NHS_LETTERS_TABLE:
            Ref: NHSLettersTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /upload
            Method: POST
      CodeUri: uploadFileFunction
    Metadata:
      SamResourceId: uploadFileFunction
  ProcessFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/process-file.processFileHandler
      Runtime: nodejs22.x
      Architectures:
      - x86_64
      MemorySize: 256
      Timeout: 60
      Description: Process uploaded files and generate AI summaries
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: ${AWS::StackName}-files-${AWS::AccountId}
      - DynamoDBCrudPolicy:
          TableName:
            Ref: NHSLettersTable
      - SSMParameterReadPolicy:
          ParameterName: OPENAI_KEY
      Environment:
        Variables:
          BUCKET_NAME:
            Fn::Sub: ${AWS::StackName}-files-${AWS::AccountId}
          NHS_LETTERS_TABLE:
            Ref: NHSLettersTable
      Events:
        S3Event:
          Type: S3
          Properties:
            Bucket:
              Ref: FilesBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                - Name: suffix
                  Value: .pdf
      CodeUri: ProcessFileFunction
    Metadata:
      SamResourceId: ProcessFileFunction
  getAllFilesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/handlers/get-all-files.getAllFilesHandler
      Runtime: nodejs22.x
      Architectures:
      - x86_64
      MemorySize: 128
      Timeout: 30
      Description: Get all uploaded files
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: NHSLettersTable
      Environment:
        Variables:
          NHS_LETTERS_TABLE:
            Ref: NHSLettersTable
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /all
            Method: GET
      CodeUri: getAllFilesFunction
    Metadata:
      SamResourceId: getAllFilesFunction
  NHSLettersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-NHSLetters
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: uploaded_at
        AttributeType: S
      - AttributeName: date_partition
        AttributeType: S
      - AttributeName: letter_date_partition
        AttributeType: S
      - AttributeName: letter_date
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: uploaded_at
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: ByUploadDate
        KeySchema:
        - AttributeName: date_partition
          KeyType: HASH
        - AttributeName: uploaded_at
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: ByLetterDate
        KeySchema:
        - AttributeName: letter_date_partition
          KeyType: HASH
        - AttributeName: letter_date
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: 'true'
Outputs:
  WebEndpoint:
    Description: API Gateway endpoint URL for Prod stage
    Value:
      Fn::Sub: https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  FilesBucketName:
    Description: S3 bucket for uploaded files
    Value:
      Ref: FilesBucket
  FilesBucketArn:
    Description: S3 bucket ARN
    Value:
      Fn::GetAtt:
      - FilesBucket
      - Arn
Globals:
  Function:
    LoggingConfig:
      LogFormat: JSON
